## Запуск ВК бота и основная логика его работы.

### Для запуска бота на PC необходимо (ОС Windows):

1. Клонировать данный репозиторий: `git clone git@github.com:s-alex-developer/Group_work_VKinder.git`
   
2. Из файла **requirements.txt** установить виртуальное окружение: `pip install -r requirements.txt`

3. Создать базу данных, например: **VKinder_db** (_имя по умолчанию в файле **.env**_)
   
4. Заполнить файл с переменными окружения **.env** - шаблон для данного проекта доступен для скачивания ниже.

6. Для запуска ВК бота будет необходимо:
   - Получить ключ доступа к сообществу, от имени которой будет общаться бот.
   - Получить токен разработчика "ВКонтакте" [dev.vk](https://dev.vk.com/)

7. Создать необходимые для работы бота таблицы в базе данных:
   
   * Для этого нужно запустить модуль `db_models.py`
   * При первом запуске модуля `db_models.py` комментируем вызов функции `#delete_tables()`, чтобы избежать ошибки при попытке удалить несуществующие таблицы в БД. (116-ая строка модуля).
   * Последующие запуски модуля в процессе тестирования и проверки необходимо выполнять с функцией `delete_tables()`

### Логика работы нашего ВК бота:

1. В процессе общения ВК бота и пользователя мы получаем данные, которые будут составлять основные параметры поиска профилей пользователей СС "ВКонтакте":
   - Город
   - Пол
   - Возрастной диапазон

2. Реализована проверка на корректность предоставляемых данных, нельзя передать в запрос несуществующий город или возрастной диапазон, если он не соответсвует предложенному шаблону.

3. Если при вводе данных пользователю допустил ошибку, будет предложено повторить попытку ввода, пока введенные данные не будут корректными.

4. Общение с пользователем ВК реализовано функцией `send_some_msg` (модуль **VKinder_bot.py**), каждый раз в процесе работы скрипта ВК бота, отправляя информационные/навигационные сообщения, результаты поиска или данные из БД текущему пользователю, мы будет выполнять эти операцию при помощи данной функции.

5. Вспомогательные функции `get_user_name_from_vk_id` и `cleans_all_tag_from_str` (модуль **VKinder_bot.py**) - позволяют используя id пользователся, который ведет общение с ботом, получить его имя и использовать в процессе дальнейшего общения в чате сообщества.

6. В результате предварительного этапа общения пользователя и ВК бота у нас формируется следующий формат данных для запроса:

   ```python
   {'user_id': ..., 'city': type_str, 'sex': ..., 'age_from': ..., 'age_to': ...}
   ```

7. Данный словарь мы передаем в качестве аргумента в функцию `get_city_id` (модуль **vk_api.py**), чтобы заменить название города, на его id в БД "ВКонтакте".
   Это будет необходимо для последующего запроса через VK API.

8. Теперь данные для запроса выглядят следующим образом:
   
    ```python
   {'user_id': ..., 'city': type_int, 'sex': ..., 'age_from': ..., 'age_to': ...}
    ```
    
9. Обновленный словарь мы передаем в функцию `search_profiles` (модуль **vk_api.py**)
    - Данная функция выполняет `get`-запросы через `VK API` и мы получаем данные профилей, которые подходят под критерии подбора, заданные пользователем ВК.
    - Дополнительно мы установили в качестве параметров поиска **"открытый профиль"** и **"наличие хотя бы одной фотографии в профиле"**.
    - В результате выполнения и обработки запросов мы получаем список словарей, имеющий следующую структуру:

      ```python
      {'first_name': ...,
      'last_name': ...,
      'photo_href_1': None,
      'photo_href_2': None,
      'photo_href_3': None,
      'result_id': ...,
      'user_id': ...,
      'vk_profile_href': ...}
      ```
    - Так же внутри данной функции реализован генератор.

10. Далее при помощи функции `add_profiles_photos` (модуль **vk_api.py**), мы дополняем полученные ранее данные тремя самыми популярным по колличеству "лайков" фотографиями.
    
    - Данная функция принимает в качестве аргумента результаты работы функции `search_profiles`
      
    - Используя возможности генератора, реализованные в функции `search_profiles` за один вызов функции `add_profiles_photos` мы получаем и наполняем фотографиями все один профиль, что ускоряет работу и процесс выдачи очередного результат поиска пользователю ВК.

12. На данном этапе нами получены все данные, необходимые для отправки пользователю ВК в качестве результата поиска:

    ```python
    {'first_name': 'Жанна',
     'last_name': 'Мидлтон',
     'photo_href_1': 'photo441843197_457239518',
     'photo_href_2': None,
     'photo_href_3': None,
     'result_id': 1,
     'user_id': 441843197,
     'vk_profile_href': 'https://vk.com/id441843197'}
     ```
13. При помощи функции `add_to_favorite_profiles` (модуль **db_func.py**) производим запись текущего/очередного результата поиска в таблицу БД `"search_results"`.
    
    - Все данные в таблице `"search_results"` храняться только для текущей сессии поиска и будут автоматичесски удалены после ее завершения.
      
14. Далее функцией `get_next` (модуль **db_func.py**) мы производит извлечение текущего результата поиска из таблицы `"search_results"` и приводим данные в пригодный формат, для отправки пользователю ВК.
    
      - В результате работы функции `get_next` мы получаем список словарей:

         ```python
         [
            {'1': f'{c.first_name} {c.last_name} \n{c.vk_profile_href}'},
            {'2': f'{c.photo_href_1},{c.photo_href_2},{c.photo_href_3}'},
            {'user_id': f'{user_id}', 'vk_profile_href': f'{c.vk_profile_href}', 'first_name': f'{c.first_name}',
             'last_name': f'{c.last_name}', 'photo_href_1': f'{c.photo_href_1}', 'photo_href_2': f'{c.photo_href_2}',
             'photo_href_3': f'{c.photo_href_3}'}
         ]
         ```
      - Первые два элемента списка с индексами 0 и 1 используются для формирования и отправки очередного результата поиска пользователю ВК бота.
     
      - Третий элемент списка с индексом 2 содержит все необходимые данные в установленном формате, для записи текущего результата поиска
     в таблицы `'favorite_profiles'` и `'blocked_profiles'`, **"Избранные"** и **"Игнорируемые"** пользователи соответственно.
     
15. Каждый раз перед отправкой очередного результата поиска пользователю ВК производится проверка:

    - Функция `check_in_favorite_profiles` (модуль **db_func.py**) - проверяет наличие текущего пользователя в таблице БД `'favorite_profiles'` - **"Избранные профили"**.
      
    - Функция `check_in_blocked_profiles` (модуль **db_func.py**) - проверяет наличие текущего пользователя в таблице БД `'blocked_profiles'` - **"Игнорируемые профили"**.
      
    - Если профиль был ранее добавлен текущим пользователем ВК в **"Избранные профили"** или **"Игнорируемые профили"** то повторно показан он не будет.
      
    - Автоматически будет вызвана функция `get_next` (модуль **db_func.py**) и мы перейдем к следующему результату поиска.
      
    - Проверка будет производится до тех пор, пока мы не дойдем до профиля, который не никак ранее не был отмечен текущим пользователем ВК.

16. Просматриваемый в данный момент пользователем ВК результат поиска, может быть добавлен в **"Избранные профили"** или **"Игнорируемые профили"**:

    - Функция `add_to_favorite_profiles` (модуль **db_func.py**) - добавляет текущий результат поиска в таблицу БД `"favorite_profiles"` - **"Избранные профили"**.
      
    - Функция `add_to_blocked_profiles` (модуль **db_func.py**) - добавляет текущий результат поиска в таблицу БД `"blocked_profiles"` - **"Игнорируемые профили"**.

17. Функция `show_favorite_profiles` (модуль **db_func.py**) - выгружает из таблицы БД `"favorite_profiles"` и отправляет текущему пользователю ВК сохраненные ранее результаты поиска, отмеченные им как **"Избранные профили"**.

18. При завершении текущей сессии поиска пользователем ВК нажатием кнопки **"Завершить поиск"**, вызывается функция `cleans_search_results` (модуль **db_func.py**), которая производит удаление всех записанных в рамках данной сессии результатов поиска из таблицы БД `"search_profiles"`.

19. Все записанные данные в таблицах `'favorite_profiles'` и `'blocked_profiles'`, **"Избранные"** и **"Игнорируемые"** профили по завершении текущей сессии поиска остаются на хранении в базе данных.

20. Функции `create_engine` и `create_session` (модуль **db_func.py**) являются вспомогательными, первая создает "движок", а вторая, принимая "движок" в качестве аргумента, открывает рабочую сессию с базой данных для получения, внесени и обновления данных.

